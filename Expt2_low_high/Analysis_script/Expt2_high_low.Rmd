---
title: "Expt-HighvsLow"
author: "Jason Geller"
date: "12/29/2020"
output:
  html_document:
    df_print: paged
    toc: true
---

# Introduction

In a preregistered study we manipulated test expectancy on on the Sans Forgetica effect/disfluency effect. We collected 232 participants (116 in each group) through MTurk. This file explains how I read in the data, analyzed it, and plotted the results. If you have any questions please reach out to me at:jason.geller@ruccs.rutgers.edu

# Read in Data

First we must load the packages and read in data for each counterbalanced list. There were four and there was no simple way to counterbalance online with PsychoPy and Pavlovia. 

```{r}
#packages you will need
library(tidyverse)
library(data.table)
library(here)
library(afex)
library(Rmisc)
library(cowplot)
library(see)
library(ggrepel)
```

```{r message=FALSE, warning=FALSE, echo=FALSE} 
# read in low test expect data exported from gorilla
setwd(here::here('Expt2_low_high', "mturk_cue_recall_low")) # folder to find Ps in

data=here::here("Expt2_low_high", "mturk_cue_recall_low")  # path to data files

file_list=list.files(data, pattern=".csv") # list of data files
 
# read in all files
datasetlow1 <-
  do.call("rbind", lapply(file_list, FUN=function(files){
    
    for (i in 1:length(files)){ 
      if(file.exists(files[i])){
        message( "now processing:", files[i])
      }
    }
    fread(files, header=TRUE, sep=",", na.strings = "", fill=TRUE)[,1:60]})) #fread makes reading in f
```

## Load in data Low cb1 condition

```{r cars}
dataset1 <- datasetlow1 %>% 
    dplyr::group_by(participant, turkid)%>%
    dplyr::filter(mouse_5.clicked_name=="polygon_2") %>% dplyr::select(textbox.text, cue1, targ1, font) %>%
    mutate(textbox.text=tolower(textbox.text)) %>% 
  dplyr::mutate(cond="Low Test Expectancy", cb="low1") %>%
 dplyr::mutate(new_id=ifelse(is.na(participant)| participant=="J", turkid,participant)) #Mturkers used "me" for participant name so we need to extract unique id
as.data.frame(dplyr::count(dataset1, new_id))
```

# load in JOls for low condition (CB1)

```{r}
dataset1_jol <- datasetlow1 %>% 
    dplyr::group_by(participant)%>%
     dplyr::select(participant,turkid, atypic_slider.response, normal_slider.response) %>%
  mutate(new_id=ifelse(is.na(participant), turkid, participant)) %>%
  mutate(new_id1=ifelse(is.na(new_id), participant, new_id))%>%
  mutate(cond="Low Test Expectancy")%>%
  ungroup() %>%
  select(new_id1,  cond, atypic_slider.response, normal_slider.response) %>%
  na.omit(.)%>%
  tidyr::pivot_longer(atypic_slider.response:normal_slider.response, names_to = "TypeFace", values_to = "jols")

as.data.frame(dplyr::count(dataset1_jol, new_id1))
```

## Get RTs

```{r}

dataset1_rt <- datasetlow1 %>% 
    dplyr::group_by(participant)%>%
     dplyr::select(participant,turkid, mouse_4.time, font) %>%
  dplyr::mutate(new_id=ifelse(is.na(participant), turkid, participant)) %>%
  dplyr::mutate(new_id1=ifelse(is.na(new_id), participant, new_id))%>%
  dplyr::mutate(cond="Low Test Expectancy")%>%
  dplyr::ungroup() %>%
  dplyr::select(new_id1, cond, font, mouse_4.time)

as.data.frame(dplyr::count(dataset1_rt, new_id1))

```


# Extract cued responses for Low Condition (CB 2)
```{r message=FALSE, warning=FALSE, echo=FALSE} 
# read in low test expect data exported from gorilla
setwd(here::here('Expt2_low_high', "mturk_cue_recall_low2")) # folder to find Ps in

data=here::here("Expt2_low_high", "mturk_cue_recall_low2")  # path to data files

file_list=list.files(data, pattern=".csv") # list of data files
 
# read in all files
datasetlow2 <-
  do.call("rbind", lapply(file_list, FUN=function(files){
    
    for (i in 1:length(files)){ 
      if(file.exists(files[i])){
        message( "now processing:", files[i])
      }
    }
    fread(files, header=TRUE, sep=",", na.strings = "", fill=TRUE)[,1:60]}))
```

```{r cars}
dataset2 <- datasetlow2 %>% 
    dplyr::group_by(participant, turkid)%>%
    dplyr::filter(mouse_5.clicked_name=="polygon_2") %>% dplyr::select(textbox.text, cue1, targ1, font) %>%
  dplyr::mutate(textbox.text=tolower(textbox.text)) %>% 
  dplyr::mutate(cond="Low Test Expectancy", cb="low2") %>%
 dplyr::mutate(new_id=ifelse(is.na(participant),turkid,participant))
#Mturkers used "me" for participant name so we need to extract unique id
#check number of Ps in each CB and make sure names are unqiue 
as.data.frame(dplyr::count(dataset2, new_id))
```

# Get JOls for cb1

```{r}
dataset2_jol <- datasetlow2 %>% 
    dplyr::group_by(participant)%>%
     dplyr::select(participant,turkid, atypic_slider.response, normal_slider.response) %>%
  mutate(new_id=ifelse(is.na(participant), turkid, participant)) %>%
  mutate(new_id1=ifelse(is.na(new_id), participant, new_id))%>%
  mutate(cond="Low Test Expectancy")%>%
  ungroup() %>%
  select(new_id1,  cond, atypic_slider.response, normal_slider.response) %>%
  na.omit(.)%>%
  tidyr::pivot_longer(atypic_slider.response:normal_slider.response, names_to = "TypeFace", values_to = "jols")

as.data.frame(dplyr::count(dataset2_jol, new_id1))
```
## RTs

```{r}

dataset2_rt <- datasetlow2 %>% 
    dplyr::group_by(participant)%>%
     dplyr::select(participant,turkid, mouse_4.time, font) %>%
  dplyr::mutate(new_id=ifelse(is.na(participant), turkid, participant)) %>%
  dplyr::mutate(new_id1=ifelse(is.na(new_id), participant, new_id))%>%
  dplyr::mutate(cond="Low Test Expectancy")%>%
  dplyr::ungroup() %>%
  dplyr::select(new_id1, cond, font, mouse_4.time)

as.data.frame(dplyr::count(dataset2_rt, new_id1))

```


# High CB 1

```{r message=FALSE, warning=FALSE, echo=FALSE} 
# read in low test expect data exported from gorilla
setwd(here::here('Expt2_low_high', "mturk_cue_recall_high")) # folder to find Ps in

data=here::here("Expt2_low_high", "mturk_cue_recall_high")  # path to data files

file_list=list.files(data, pattern=".csv") # list of data files
 
# read in all files
datasethigh3 <-
  do.call("rbind", lapply(file_list, FUN=function(files){
    
    for (i in 1:length(files)){ 
      if(file.exists(files[i])){
        message( "now processing:", files[i])
      }
    }
    fread(files, header=TRUE, sep=",", na.strings = "", fill=TRUE)[,1:70]})) #fread makes reading in f
```


## Cued Responses

```{r cars}
dataset3 <- datasethigh3 %>% 
    dplyr::group_by(participant, turkid)%>%
    dplyr::filter(mouse_5.clicked_name=="polygon_2") %>% dplyr::select(textbox.text, cue1, targ1, font) %>%
  dplyr::mutate(textbox.text=tolower(textbox.text)) %>% 
  dplyr::mutate(cond="High Test Expectancy", cb="high1") %>%
 dplyr::mutate(new_id=ifelse(is.na(participant),turkid,participant))
#Mturkers used "me" for participant name so we need to extract unique id
#check number of Ps in each CB and make sure names are unqiue 
as.data.frame(dplyr::count(dataset2, new_id))
```

## JOLs

```{r}
dataset3_jol <- datasethigh3 %>% 
    dplyr::group_by(participant)%>%
     dplyr::select(participant,turkid, atypic_slider.response, normal_slider.response) %>%
  mutate(new_id=ifelse(is.na(participant), turkid, participant)) %>%
  mutate(new_id1=ifelse(is.na(new_id), participant, new_id))%>%
  mutate(cond="High Test Expectancy")%>%
  ungroup() %>%
  select(new_id1,  cond, atypic_slider.response, normal_slider.response) %>%
  na.omit(.)%>%
  tidyr::pivot_longer(atypic_slider.response:normal_slider.response, names_to = "TypeFace", values_to = "jols")

as.data.frame(dplyr::count(dataset3_jol, new_id1))
```

```{r}

dataset3_rt <- datasethigh3 %>% 
    dplyr::group_by(participant)%>%
     dplyr::select(participant,turkid, mouse_4.time, font) %>%
  dplyr::mutate(new_id=ifelse(is.na(participant), turkid, participant)) %>%
  dplyr::mutate(new_id1=ifelse(is.na(new_id), participant, new_id))%>%
  dplyr::mutate(cond="High Test Expectancy")%>%
  dplyr::ungroup() %>%
  dplyr::select(new_id1, cond, font, mouse_4.time)

as.data.frame(dplyr::count(dataset3_rt, new_id1))

```

# High CB 2

```{r message=FALSE, warning=FALSE, echo=FALSE} 
# read in low test expect data exported from gorilla
setwd(here::here('Expt2_low_high', "mturk_cue_recall_high2")) # folder to find Ps in

data=here::here("Expt2_low_high", "mturk_cue_recall_high2")  # path to data files

file_list=list.files(data, pattern=".csv") # list of data files
 
# read in all files
datasethigh4 <-
  do.call("rbind", lapply(file_list, FUN=function(files){
    
    for (i in 1:length(files)){ 
      if(file.exists(files[i])){
        message( "now processing:", files[i])
      }
    }
    fread(files, header=TRUE, sep=",", na.strings = "", fill=TRUE)[,1:70]})) #fread makes reading in f
```

# Cued Responses

```{r}
dataset4 <- datasethigh4 %>% 
    dplyr::group_by(participant, turkid)%>%
    dplyr::filter(mouse_5.clicked_name=="polygon_2") %>% dplyr::select(textbox.text, cue1, targ1, font) %>%
  dplyr::mutate(textbox.text=tolower(textbox.text)) %>% 
  dplyr::mutate(cond="High Test Expectancy", cb="high2") %>%
 dplyr::mutate(new_id=ifelse(is.na(participant),turkid,participant))
#Mturkers used "me" for participant name so we need to extract unique id
#check number of Ps in each CB and make sure names are unqiue 
as.data.frame(dplyr::count(dataset2, new_id))
```
## JOLs 

```{r}
dataset4_jol <- datasethigh4 %>% 
    dplyr::group_by(participant)%>%
     dplyr::select(participant,turkid, atypic_slider.response, normal_slider.response) %>%
  mutate(new_id=ifelse(is.na(participant), turkid, participant)) %>%
  mutate(new_id1=ifelse(is.na(new_id), participant, new_id))%>%
  mutate(cond="High Test Expectancy")%>%
  ungroup() %>%
  select(new_id1,  cond, atypic_slider.response, normal_slider.response) %>%
  na.omit(.)%>%
  tidyr::pivot_longer(atypic_slider.response:normal_slider.response, names_to = "TypeFace", values_to = "jols")

as.data.frame(dplyr::count(dataset3_jol, new_id1))
```


## RTs


```{r}

dataset4_rt <- datasethigh4 %>% 
    dplyr::group_by(participant)%>%
     dplyr::select(participant,turkid, mouse_4.time, font) %>%
  dplyr::mutate(new_id=ifelse(is.na(participant), turkid, participant)) %>%
  dplyr::mutate(new_id1=ifelse(is.na(new_id), participant, new_id))%>%
  dplyr::mutate(cond="High Test Expectancy")%>%
  dplyr::ungroup() %>%
  dplyr::select(new_id1, cond, font, mouse_4.time)

as.data.frame(dplyr::count(dataset4_rt, new_id1))

```
 
 
 Combine High and Low CB lists

```{r}
all_c<- rbind(dataset1, dataset2, dataset3, dataset4)

all_c %>% group_by(cb) %>% dplyr::summarise(count = n()) # make sure equal number of Ps in cbs


as.data.frame(dplyr::count(all_c, new_id))


write.csv(all_c, file="test_expect.csv")

```
# Analysis

## Cued Recall

Read in data from the scored folder and aggreagte (long and wide)

```{r}
setwd(here::here('Expt2_low_high', "Summary", "scored")) # folder to find Ps in

recall_highlow<-read.csv(here::here('Expt2_low_high', "Summary","scored", "Expt2_scored_recall.csv")) # folder to find Ps in)
```
```{r}
recall_highlow_agg_wide <- recall_highlow %>% 
  dplyr::group_by(id, font, cond) %>%
  dplyr::summarise(mean_acc=mean(Scored))%>%
  tidyr::pivot_wider(names_from = "font", values_from = "mean_acc")

recall_highlow_agg <- recall_highlow %>% 
  dplyr::group_by(id, font, cond) %>%
  dplyr::summarise(mean_acc=mean(Scored))

  
```


```{r}
#ANOVA

a1 <- aov_ez("id", "mean_acc", recall_highlow_agg, 
            within=c("font"), between=c("cond")) # mixed

summary(a1)

a1
```

### Testing Interaction

```{r}
Within_Fitted_Interaction <- emmeans(a1, ~ font|cond)

Within_Fitted_Interaction

```

### Planned Comparisons

```{r}

pairs(Within_Fitted_Interaction) ## pairwise comparison with no correction


```
## JOLs

```{r}
all_jol <- rbind(dataset1_jol, dataset2_jol, dataset3_jol, dataset4_jol)
```


## 2 x 2 ANOVA

```{r}
#ANOVA

jol_a <- aov_ez("new_id1", "jols", all_jol, 
            within=c("TypeFace"), between=c("cond")) # mixed

summary(jol_a)
```

## Testing Interaction 
```{r}
Within_Fitted_Interaction <- emmeans(jol_a, ~ TypeFace|cond)

Within_Fitted_Interaction

```

```{r}

pairs(Within_Fitted_Interaction) ## pairwise comparison with no correction


```


## RTs

### 2 x 2 Mixed ANOVA

```{r}
rt_all <- rbind(dataset1_rt, dataset2_rt, dataset3_rt, dataset4_rt)

rt_all1<- rt_all %>% 
  dplyr::group_by(new_id1, font, cond) %>% 
dplyr::mutate(sdabove = mean(mouse_4.time, na.rm=TRUE) +  2.5*sd(mouse_4.time, na.rm=TRUE)) %>%
    dplyr::filter(mouse_4.time > .150, mouse_4.time < sdabove) %>%
  dplyr::summarise(mean_rt= mean(log(mouse_4.time))) %>%
   mutate(font=ifelse(font=="flu", "Arial", "Sans Forgetica"))
  


```

```{r}
#ANOVA

rt_a <- aov_ez("new_id1", "mean_rt",rt_all1, 
            within=c("font"), between=c("cond")) # mixed

summary(rt_a)
```
#### Main Effects

No interaction, but main effets

```{r}
Within_font <- emmeans(rt_a, ~ font)

Within_font

Within_cond <- emmeans(rt_a, ~ cond)

Within_cond

```

# Plot

## Cued Recall


```{r}

library(see)
library(ggrepel)

#load in violin plot code
source("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R")

bold <- element_text(face = "bold", color = "black", size = 14) 

recall_highlow_agg <- recall_highlow_agg %>%
  dplyr::mutate(Typeface=ifelse(font=="SF", "Sans Forgetica", "Arial"))

#means by test and typeface 
means = recall_highlow_agg %>%
  dplyr::group_by(cond, Typeface)%>% 
  dplyr::summarise(mean=mean(mean_acc))

# get withinsub CIs
sfarial_wsci=summarySEwithin(data = recall_highlow_agg, measurevar = "mean_acc",
                       withinvars = "Typeface", betweenvars = "cond", idvar = "id")

recall_highlow_agg

```

```{r}

fig3a <- ggplot(recall_highlow_agg,aes(x=Typeface,y=mean_acc,fill=Typeface))+ 
  facet_grid(~cond) + 
  geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .4,adjust=4)+
  geom_point(position=position_jitter(width = .15),size = 1, alpha = 0.2) +
  geom_boxplot(aes(x = Typeface, y = mean_acc ),outlier.shape = NA,
               alpha = 0.3, width = .1, colour = "BLACK") +
    #stat_summary(fun="mean", geom="point", colour="darkred", size=3)+
  geom_line(data=sfarial_wsci,aes(y=mean_acc, group=1), size=1)+ 
  geom_pointrange(data=sfarial_wsci, aes(y=mean_acc, ymin=mean_acc-ci, ymax=mean_acc+ci), size=1, color="red")+ 
  theme_cowplot() +
  scale_colour_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2") +
  labs(y = "Porportion Correct on Final Test", x = "Typeface") + theme(legend.position = "none") + 
   geom_label_repel(data=sfarial_wsci, aes(y=mean_acc, label=round(mean_acc, 2)), min.segment.length = 0, seed = 42, box.padding = 0.5)


print(fig3a)

```


## JOL
```{r}

jol_rename <- all_jol %>%
  mutate(Typeface=ifelse(TypeFace=="atypic_slider.response", "Sans Forgetica", "Arial"))

means = jol_rename %>%
  dplyr::group_by(cond, Typeface)%>% 
  dplyr::summarise(mean=mean(jols))

# get withinsubject CIs
sfgenjol_wsci= Rmisc::summarySEwithin(data = jol_rename, measurevar = "jols",
                       withinvars = "Typeface", betweenvars = "cond", idvar = "new_id1")


fig3b <- ggplot(jol_rename,aes(x=Typeface,y=jols,fill=Typeface))+ facet_grid(~cond) + 
  geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .4,adjust=4)+
  geom_point(position=position_jitter(width = .15),size = 1, alpha = 0.2) +
  geom_boxplot(aes(x = Typeface, y = jols),outlier.shape = NA,
               alpha = 0.3, width = .1, colour = "BLACK") +
   #stat_summary(fun="mean", geom="point", colour="darkred", size=3)+
  geom_line(data=sfgenjol_wsci,aes(y=jols, group=1), size=1)+ 
  geom_pointrange(data=sfgenjol_wsci, aes(y=jols, ymin=jols-ci, ymax=jols+ci), size=1, color="red")+ 
  theme_cowplot() +
  scale_colour_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2") +
  labs(y = "Judgements of Learning", x = "Typeface") + theme(legend.position = "none") + 
   geom_label_repel(data=sfgenjol_wsci, aes(y=jols, label=round(jols, 2)), min.segment.length = 0, seed = 42, box.padding = 0.1)



```

## RTs

```{r}

means = rt_all1 %>%
  dplyr::group_by(cond, font)%>% 
  dplyr::summarise(mean=mean(font))

# get withinsubject CIs
sfgenrt_wsci= Rmisc::summarySEwithin(data = rt_all1, measurevar = "mean_rt",
                       withinvars = "font", betweenvars = "cond", idvar = "new_id1")


fig3c <- ggplot(rt_all1,aes(x=font,y=mean_rt,fill=font))+ facet_grid(~cond) + 
  geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .4,adjust=4)+
  geom_point(position=position_jitter(width = .15),size = 1, alpha = 0.2) +
  geom_boxplot(aes(x = font , y = mean_rt),outlier.shape = NA,
               alpha = 0.3, width = .1, colour = "BLACK") +
   #stat_summary(fun="mean", geom="point", colour="darkred", size=3)+
  geom_line(data=sfgenrt_wsci,aes(y=mean_rt, group=1), size=1)+ 
  geom_pointrange(data=sfgenrt_wsci, aes(y=mean_rt, ymin=mean_rt-ci, ymax=mean_rt+ci), size=1, color="red")+ 
  theme_cowplot() +
  scale_colour_brewer(palette = "Dark2")+
  scale_fill_brewer(palette = "Dark2") +
  labs(y = "log(RT/s)", x = "Typeface") + theme(legend.position = "none") + 
   geom_label_repel(data=sfgenrt_wsci, aes(y=mean_rt, label=round(mean_rt, 2)), min.segment.length = 0, seed = 42, box.padding = 0.1)

```
# Combine Plots


```{r}

fig3 <- plot_grid(
  fig3a, fig3b, fig3c,
  labels = "AUTO", ncol= 2, nrow = 2
)


```